if getgenv().AoInjected == true then return end
getgenv().AoInjected = true

task.spawn(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Idktbh12z/ArcaneYIELD/refs/heads/main/main.lua"))()
end)

local Compkiller = loadstring(game:HttpGet("https://gist.githubusercontent.com/AstraTheFomx/b7276abb673cfc832ef6797c97f77aae/raw/22b82c437ddda78bc964f935c2ec1eaca752d464/PaidUiLib.lua"))();
local Version = "v2.8.4b"

local Notifier = Compkiller.newNotify();
Compkiller:Loader("rbxassetid://463021019" , 0.5).yield();

local Window = Compkiller.new({
	Name = "Eldritch Hub",
	Keybind = "Equals",
	Logo = "rbxassetid://463021019",
	TextSize = 12,
});

local Watermark = Window:Watermark();

-- Services & cached refs (localized for perf)
local workspace = cloneref(game:GetService("Workspace"))
local lighting = cloneref(game:GetService("Lighting"))
local players = cloneref(game:GetService("Players"))
local replicated = cloneref(game:GetService("ReplicatedStorage"))
local uis = cloneref(game:GetService("UserInputService"))
local runService = cloneref(game:GetService("RunService"))
local starterGui = cloneref(game:GetService("StarterGui"))
local coreGui = cloneref(game:GetService("CoreGui"))
local VirtualUser = cloneref(game:GetService("VirtualUser"))

local LocalPlayer = players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local CurrentCamera = workspace.CurrentCamera
local Map = workspace:WaitForChild("Map", 10)
local DarkSeaFolder = Map:FindFirstChild("SeaContent") and Map.SeaContent:FindFirstChild("DarkSea")
local NPCs = workspace:WaitForChild("NPCs")
local BoatsFolder = workspace:WaitForChild("Boats")
local RS = replicated:WaitForChild("RS", 10)
local Remotes = RS:WaitForChild("Remotes")
local TeleportBind = Instance.new("BindableFunction")
local enemiesFolder = workspace:WaitForChild("Enemies")

Watermark:AddText({ Icon = "user", Text = Version, });

-- Modules (cached)
local MagicModule = require(RS.Modules.Magic)
local MeleeModule = require(RS.Modules.Melee)
local BasicModule = require(RS.Modules.Basic)
local AttackClientModule = require(RS.Modules.AttackClient)
local InventoryModule = require(RS.Modules.Inventory)

-- State
local teleportDebounce = false
local StaminaBoostDebounce = false
local inHook = false
local fillDebounce = false
local LChestDebounce = false
local hecatePart = nil
local infiniteZoomConnection = nil
local oldZoomDistance = LocalPlayer.CameraMaxZoomDistance
local OldTimeModule = BasicModule.GetTime
local OldAtmosphere = nil
local NaNNumber = 0/0
local childAddedConnection
local fishingTask = nil
local fishingToolName = nil
local FishingTool = nil
local fishingType = "Legit"

local scheduler = {
    buckets = {
        [0.1] = {},
        [0.5] = {},
        [1] = {},
        [5] = {},
        [15] = {},
    },
    nearestBucket = function(self, interval)
        if interval <= 0.1 then return 0.1 end
        if interval <= 0.5 then return 0.5 end
        if interval <= 1 then return 1 end
        if interval <= 5 then return 5 end
        return 15
    end,
    add = function(self, name, interval, fn)
        local b = self:nearestBucket(interval)
        self.buckets[b][name] = { interval = interval, fn = fn, nextRun = tick() + interval }
    end,
    remove = function(self, name)
        for b, tbl in self.buckets do tbl[name] = nil end
    end
}

-- Anti-AFK
task.spawn(function()
    LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()

        local viewportSize = CurrentCamera.ViewportSize
        local centerX = viewportSize.X / 2
        local centerY = viewportSize.Y / 2

        local offsetX = math.random(-100, 100)
        local offsetY = math.random(-100, 100)

        local randomPos = Vector2.new(
            centerX + offsetX,
            centerY + offsetY
        )

        VirtualUser:ClickButton2(randomPos)
    end)
end)

-- sets/maps for O(1) checks
local DAMAGE_REMOTES_SET = {
    DealAttackDamage = true, DealStrengthDamage = true, DealWeaponDamage = true,
    DealMagicDamage = true, DealDamageBoat = true, DealDamageBoat3 = true,
    DealDamageBoat2 = true, DealDamageBoat1 = true, DealSWDamage = true
}

-- Settings
local settings = {
    ItemEspRadius = 1000,
    DamageMultiplier = 1,
    BoatSpeedMultiplier = 1,
    RepairMultiplier = 1,
    ChestRadius = 25,
    EnableDamageMultiplier = false,
    GodMode = false,
    BlockNPCAggro = false,
    FastBoatRepair = false,
    NoTracking = false,
    ReduceStamina = false,
    OneTapStructures = false,
    QuickFillBottles = false,
    SpawnLightning = false,
    SilentBottleDrinking = false,
    AutoFish = false,
    AutoWash = false,
    HecateNotifier = false,
    EpicenterESP = false,
    BoatESP = false,
    BoostBoatSpeed = false,
    AutoEat = false,
    IsEating = false,
    PlayerDamageMulti = false,
    NPCEspActive = false,
    SpoofingMagic = false,
    ChestAura = false,
    WeaponDamageMultiplier = false,
    WeaponDamageAmt = 0,
}

-- Modified stats and lists
local modifiedStats = {
    Melee = nil, Melee2 = nil,
    Weapon = nil, Weapon2 = nil, Weapon3 = nil,
    Magic = nil, Magic2 = nil,
    Armor = nil,
    FoodItem = nil,
    SpoofedMagic = nil,
}

-- ESP storage (now O(1))
local espData = { Island = nil, Gui = nil, RegisteredItems = {}, RegisteredMap = {}, TrackingFrame = nil }
local folderFilter = { Herbs = true, Fruits = true, Chests = true, Coconuts = true, Seaweed = true, Shells = true }
local sealedNames = { ["Bronze Sealed Chest"] = true, ["Nimbus Sealed Chest"] = true, ["Dark Sealed Chest"] = true }
local NpcEspData = {} -- map: Model -> {gui, labelRef, conns}
local SpoofMagicTable = {"None"}
local magicTypes = {"None"}
local meleeTypes = {"None"}
local weaponTypes = {"None"}
local itemTypes = {}
local teleportLocations = {}
local teleportLocationsExtended = {}

-- populate teleport lists etc
for _, folder in pairs(Map:GetChildren()) do
    if folder:FindFirstChild("Center") then 
        table.insert(teleportLocations, folder.Name)
        table.insert(teleportLocationsExtended, folder.Name)
    end
end
table.insert(teleportLocationsExtended, "Diving Spots")
table.insert(teleportLocationsExtended, "Sealed Chests")
table.insert(teleportLocationsExtended, "Dark Sea Islands")

table.sort(teleportLocations)
table.sort(teleportLocationsExtended)

for name,Magic in pairs(MagicModule.Types) do
    if Magic["Type"] ~= "Base Magic" then continue end
    table.insert(magicTypes, name)
end
table.sort(magicTypes)

for meleeType in pairs(MeleeModule.Types) do
    table.insert(meleeTypes, meleeType)
end
table.sort(meleeTypes)

for itemName, itemData in pairs(InventoryModule.Items) do
    if itemData.WeaponType then table.insert(weaponTypes, itemName) end
    if itemData.Type == "Accessory" or itemData.Type == "Chestpiece" or itemData.Type == "Leggings" then
        table.insert(itemTypes, itemName)
    end
end
table.sort(itemTypes)
table.sort(weaponTypes)

-- UI creation (same layout)
Window:DrawCategory({Name = "Main"})
local MainTab = Window:DrawTab({ Name = "Main", Icon = "apple", EnableScrolling = true });
local GodmodeSection = MainTab:DrawSection({Name = "Godmode", Position = 'left'});
local DamageSection = MainTab:DrawSection({Name = "Damage Exploits", Position = 'left'});
local NPCSection = MainTab:DrawSection({Name = "NPC Exploits", Position = 'left'});
local EatSection = MainTab:DrawSection({Name = "Auto eat", Position = 'left'});
local UISection = MainTab:DrawSection({Name = "UI", Position = 'left'});

Window:DrawCategory({Name = "Exploits"})
local ExploitsTab = Window:DrawTab({ Name = "Exploits", Icon = "apple", EnableScrolling = true});
local BoatSection = ExploitsTab:DrawSection({Name = "Boat Exploits", Position = 'left'});
local WeaponEXPSection = ExploitsTab:DrawSection({Name = "Weapon Exploits", Position = 'left'});
local PlayerSection = ExploitsTab:DrawSection({Name = "Player Exploits", Position = 'left'});

Window:DrawCategory({Name = "Item Exploits"})
local ItemExploitsTab = Window:DrawTab({ Name = "Item Exploits", Icon = "apple", EnableScrolling = true});
local ItemsSection = ItemExploitsTab:DrawSection({Name = "Item Exploits", Position = 'left'});
local ChestExploitsSection = ItemExploitsTab:DrawSection({Name = "Chest Exploits", Position = 'left'});

Window:DrawCategory({Name = "Fishing Exploits"})
local FishingExploitsTab = Window:DrawTab({ Name = "Fishing Exploits", Icon = "apple", EnableScrolling = true});
local FishingSection = FishingExploitsTab:DrawSection({Name = "Fish Exploits", Position = 'left'});

Window:DrawCategory({Name = "Module Exploits"})
local ModuleExploitsTab = Window:DrawTab({ Name = "Module Exploits", Icon = "apple", EnableScrolling = true});
local MagicSection = ModuleExploitsTab:DrawSection({Name = "Magic Exploits", Position = 'left'});
local MeleeSection = ModuleExploitsTab:DrawSection({Name = "Melee Exploits", Position = 'left'});
local WeaponsSection = ModuleExploitsTab:DrawSection({Name = "Weapon Exploits", Position = 'left'});
local ArmorSection = ModuleExploitsTab:DrawSection({Name = "Armor Exploits", Position = 'left'});

Window:DrawCategory({Name = "Dark Sea"})
local DarkSeaTab = Window:DrawTab({ Name = "Dark Sea", Icon = "apple", EnableScrolling = true});
local DarkSeaSection = DarkSeaTab:DrawSection({Name = "Dark Sea Exploits", Position = 'left'});

-- Window:DrawCategory({Name = "Magic Spoof"})
-- local MagicSpoofingTab = Window:DrawTab({ Name = "Magic Spoof", Icon = "apple", EnableScrolling = true});
-- local SpoofPageSection = MagicSpoofingTab:DrawSection({Name = "Spoofing", Position = 'left'});

Window:DrawCategory({Name = "Teleports"})
local TeleportsTab = Window:DrawTab({ Name = "Teleports", Icon = "apple", EnableScrolling = true});
local TeleportSection = TeleportsTab:DrawSection({Name = "Teleports", Position = 'left'});

Window:DrawCategory({Name = "Misc"})
local MiscTab = Window:DrawTab({ Name = "Misc", Icon = "apple", EnableScrolling = true});
local MiscSection = MiscTab:DrawSection({Name = "Misc", Position = 'left'});
local NavySection = MiscTab:DrawSection({Name = "Navy Influence", Position = 'left'});
local DiscordSection = MiscTab:DrawSection({Name = "Discord", Position = 'left'});

-- Helper utilities
local function generateRandomString()
    local length = math.random(10, 20)
    local chars = {}
    for i = 1, length do
        chars[i] = string.char(math.random(32, 126))
    end
    return table.concat(chars)
end

local function toPercentage(value)
    return string.format("%d%%", math.floor((value / 10000)))
end

local function darkenColor3(color, factor)
    return Color3.new(
        color.R * factor,
        color.G * factor,
        color.B * factor
    )
end

-- OpenChest with a cooldown table to avoid repeated rapid firing (weak-keyed)
local openCooldown = setmetatable({}, { __mode = "k" })
local function OpenChest(Chest)
    if not Chest or not Chest:IsA("Model") then return end
    if openCooldown[Chest] and tick() - openCooldown[Chest] < 3 then return end
    local base = Chest:FindFirstChild("Base")
    if not base then return end
    local ProximityPrompt = base:FindFirstChildOfClass("ProximityPrompt")
    if not ProximityPrompt then return end
    if base.Transparency >= 0.3 then return end
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return end

    local Magnitude = (Character.HumanoidRootPart.Position - base.Position).Magnitude
    if Magnitude > settings.ChestRadius then return end

    openCooldown[Chest] = tick()
    fireproximityprompt(ProximityPrompt)
end

-- scanIslandItems uses early island distance rejection and limited folder checks
function scanIslandItems(MapRef, CharacterRef, registerItemESP)
    local RootPart = CharacterRef:FindFirstChild("HumanoidRootPart")
    if not RootPart then return end

    local myPos = RootPart.Position
    local radius = settings.ItemEspRadius
    local radiusSq = radius * radius -- Correct way to handle squared magnitude in Luau

    -- Fast helper for distance checks
    local function tryRegister(part, className, ActionColor)
        if part and part:IsA("BasePart") then
            local diff = myPos - part.Position
            -- Manual squared magnitude calculation: x^2 + y^2 + z^2
            if (diff.X^2 + diff.Y^2 + diff.Z^2) <= radiusSq then
                registerItemESP(part, className or part.ClassName, ActionColor)
            end
        end
    end

    -- 1. Scan Islands (Generalized Iteration)
    for _, island in MapRef:GetChildren() do
        local center = island:FindFirstChild("Center")
        if center then
            local diff = myPos - center.Position
            local distSq = (diff.X^2 + diff.Y^2 + diff.Z^2)
            -- Skip entire island if too far (buffer of 500)
            if distSq > (radius + 500)^2 then continue end
        end
        
        for _, folder in island:GetChildren() do
            if folderFilter[folder.Name] then
                for _, item in folder:GetChildren() do
                    if folder.Name == "Chests" then
                        local Base = item:FindFirstChild("Base")

                        if not Base then continue end

                        local ActionColorInstance = Base:FindFirstChild("Prompt"):FindFirstChild("ActionColor")
                    
                        tryRegister(Base, "BasePart", ActionColorInstance)
                    else
                        tryRegister(item, item.ClassName)
                    end
                end
            end
        end
    end

    -- 2. Scan SeaContent (Diving/Structures)
    local SeaContent = MapRef:FindFirstChild("SeaContent")
    if SeaContent then
        for _, model in SeaContent:GetChildren() do
            if model.Name == "DivingSpot" or model.Name == "UWStructure" then
                for _, folder in model:GetChildren() do
                    if folder.Name == "Chests" then
                        for _, chest in folder:GetChildren() do
                            local Base = chest:FindFirstChild("Base")

                            if not Base then continue end

                            local ActionColorInstance = Base:FindFirstChild("Prompt"):FindFirstChild("ActionColor")
                        
                            tryRegister(Base, "BasePart", ActionColorInstance)
                        end
                    elseif folder.Name == "Details" then
                        for _, herb in folder:GetChildren() do
                            if herb:FindFirstChildOfClass("ProximityPrompt") then
                                tryRegister(herb, herb.ClassName)
                            end
                        end
                    end
                end
            end
        end
    end

    -- 3. Scan Temporary (Sealed Chests)
    local tempFolder = MapRef:FindFirstChild("Temporary")
    if tempFolder then
        for _, sealed in tempFolder:GetChildren() do
            if sealedNames[sealed.Name] and sealed:FindFirstChildOfClass("ProximityPrompt") then
                local ActionColorInstance = sealed:FindFirstChild("Prompt"):FindFirstChild("ActionColor")
            
                tryRegister(sealed, "MeshPart", ActionColorInstance)
            end
        end
    end

    -- 4. Dark Sea
    local darkSea = SeaContent and SeaContent:FindFirstChild("DarkSea")
    if darkSea then
        for _, model in darkSea:GetChildren() do
            for _, folder in model:GetChildren() do
                if folderFilter[folder.Name] then
                    for _, Item in folder:GetChildren() do
                        if folder.Name == "Chests" then
                            local Base = Item:FindFirstChild("Base")

                            if not Base then continue end

                            local ActionColorInstance = Base:FindFirstChild("Prompt"):FindFirstChild("ActionColor")
                        
                            tryRegister(Base, "BasePart", ActionColorInstance)
                        else
                            tryRegister(Item, Item.ClassName)
                        end
                    end
                end
            end
        end
    end
end

function GrabLegendaryChests()
    local Count = 0

    for _, v in game:GetDescendants() do
        if v:IsA("ProximityPrompt") then
            local text = v.ObjectText
            if text ~= "" and string.find(text:lower(), "legendary chest", 1, true) then
                local model = v.Parent.Parent
                if not model then continue end

                if model.Name == "Items" then continue end
                if model:FindFirstChild("Open") then continue end

                Count += 1

                -- Highlight (keep your naming)
                if not model:FindFirstChildWhichIsA("Highlight") then
                    local highlight = Instance.new("Highlight")
                    highlight.Name =
                        "LegendaryHighlight "
                        .. tostring(Count)
                        .. " "
                        .. tostring(math.random(-1000, 1000))

                    highlight.Adornee = model
                    highlight.FillTransparency = 0.6
                    highlight.OutlineTransparency = 0
                    highlight.Parent = model
                end

                -- Teleport ONLY once (first valid chest)
                if not Teleported then
                    local primary = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
                    if primary then
                        Character:FindFirstChild("HumanoidRootPart").CFrame = primary.CFrame
                        Teleported = true
                    end
                end
            end
        end
    end

    starterGui:SetCore("SendNotification", {
        Title = "Legendary chests found:",
        Text = "Amount: "..tostring(Count),
        Duration = 5,
    })

    LChestDebounce = false
    Count = nil
    Teleported = false
end

-- Chest cache (event-driven with debounce)
local cachedChestParts = {}
local chestCacheDebounce = false
local function buildChestCache()
    if chestCacheDebounce then return end
    chestCacheDebounce = true
    task.spawn(function()
        local newCache = {}
        for _, island in pairs(Map:GetChildren()) do
            local chests = island:FindFirstChild("Chests")
            if chests then
                for _, chest in pairs(chests:GetChildren()) do
                    if chest:FindFirstChild("Base") then
                        table.insert(newCache, chest)
                    end
                end
            end
        end

        local SeaContent = Map:FindFirstChild("SeaContent")
        if SeaContent then
            for _, model in pairs(SeaContent:GetChildren()) do
                if model:IsA("Model") then
                    local chests = model:FindFirstChild("Chests")
                    if chests then
                        for _, chest in pairs(chests:GetChildren()) do
                            table.insert(newCache, chest)
                        end
                    end
                end
            end
        end

        local tempFolder = Map:FindFirstChild("Temporary")
        if tempFolder then
            for _, sealed in pairs(tempFolder:GetChildren()) do
                if (sealed.Name == "Bronze Sealed Chest" or sealed.Name == "Nimbus Sealed Chest" or sealed.Name == "Dark Sealed Chest")
                    and sealed:FindFirstChildOfClass("ProximityPrompt") then
                    table.insert(newCache, sealed)
                end
            end
        end

        if DarkSeaFolder then
            for _, model in pairs(DarkSeaFolder:GetChildren()) do
                local ChestsFolder = model:FindFirstChild("Chests")
                if ChestsFolder then
                    for _, chest in pairs(ChestsFolder:GetChildren()) do
                        table.insert(newCache, chest)
                    end
                end
            end
        end

        cachedChestParts = newCache
        task.delay(1, function() chestCacheDebounce = false end)
    end)
end

-- Debounced rebuild on map changes
Map.ChildAdded:Connect(function() task.delay(1, buildChestCache) end)
Map.ChildRemoved:Connect(function() task.delay(1, buildChestCache) end)
if Map:FindFirstChild("SeaContent") then
    Map.SeaContent.ChildAdded:Connect(function() task.delay(1, buildChestCache) end)
    Map.SeaContent.ChildRemoved:Connect(function() task.delay(1, buildChestCache) end)
end

-- build initial cache
buildChestCache()

-- Item ESP registration optimized with O(1) lookups & better event cleanup
local ALLOWED_ESP_TYPES = { BasePart=true, MeshPart=true, Part=true, Model=true }

local function unregisterItemESP(part)
    local record = espData.RegisteredMap[part]
    if record then
        local gui = record.gui
        if gui and gui.Parent then gui:Destroy() end
        -- disconnect connections
        if record.conns then
            for _, c in pairs(record.conns) do if c and c.Connected then c:Disconnect() end end
        end
        espData.RegisteredMap[part] = nil
    end
end

local function registerItemESP(part, itemType, ActionColor)
    if not part then return end
    if not (ALLOWED_ESP_TYPES[part.ClassName] or part:IsA("Model")) then return end
    if part.Transparency and part.Transparency >= 1 then return end
    if espData.RegisteredMap[part] then return end

    local parentPart = part:IsA("Model") and (part.PrimaryPart or part:FindFirstChildOfClass("BasePart")) or part
    if not parentPart then return end

    local DarkenedColor = nil

    if ActionColor ~= nil then DarkenedColor = darkenColor3(ActionColor.Value, 0.2) end

    local espGui = Instance.new("BillboardGui")
    espGui.Name = generateRandomString()
    espGui.Parent = parentPart
    espGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    espGui.Active = true
    espGui.AlwaysOnTop = true
    espGui.LightInfluence = 1
    espGui.Size = UDim2.new(0, 150, 0, 25)
    espGui.StudsOffset = Vector3.new(0, 1.5, 0)
    espGui.MaxDistance = math.huge

    local frame = Instance.new("Frame")
    frame.Parent = espGui
    frame.BackgroundTransparency = 1
    frame.Size = UDim2.new(1, 0, 1, 0)

    local label = Instance.new("TextLabel")
    label.Parent = frame
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Font = Enum.Font.FredokaOne
    label.TextColor3 = ActionColor and ActionColor.Value or Color3.fromRGB(102, 102, 102)
    label.TextScaled = true

    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 3
    stroke.Color = ActionColor and DarkenedColor or Color3.new(1,1,1)
    stroke.Parent = label

    if part:FindFirstChildOfClass("ProximityPrompt") then
        label.Text = part:FindFirstChildOfClass("ProximityPrompt").ObjectText
    elseif (itemType or ""):lower() == "model" then
        label.Text = part.Parent and part.Parent.Name or part.Name
    else
        label.Text = part.Name
    end

    local conns = {}
    table.insert(conns, parentPart.Destroying:Connect(function() unregisterItemESP(part) end))
    table.insert(conns, parentPart:GetPropertyChangedSignal("Transparency"):Connect(function()
        if parentPart.Transparency >= 1 then unregisterItemESP(part) end
    end))

    espData.RegisteredMap[part] = { gui = espGui, conns = conns }
end

-- NPC ESP (event-driven). Reuse create/destroy logic and store per-model data
local function createNpcEspForModel(Model)
    if not Model or not Model:FindFirstChildOfClass("Humanoid") then return end
    if NpcEspData[Model] then return end

    local humanoid = Model:FindFirstChildOfClass("Humanoid")
    local adorneePart = Model:FindFirstChild("HumanoidRootPart")
    if not adorneePart then
        for _, Part in pairs(Model:GetChildren()) do
            if Part:IsA("BasePart") then adorneePart = Part; break end
        end
    end
    if not adorneePart then return end

    local espGui = Instance.new("BillboardGui")
    espGui.Name = generateRandomString()
    espGui.Parent = adorneePart
    espGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    espGui.Active = true
    espGui.AlwaysOnTop = true
    espGui.LightInfluence = 0
    espGui.Size = UDim2.new(0, 180, 0, 35)
    espGui.StudsOffset = Vector3.new(0, adorneePart.Size.Y / 2 + 1.5, 0)
    espGui.MaxDistance = math.huge

    local frame = Instance.new("Frame")
    frame.Parent = espGui
    frame.BackgroundTransparency = 1
    frame.Size = UDim2.new(1, 0, 1, 0)

    local label = Instance.new("TextLabel")
    label.Parent = frame
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Font = Enum.Font.FredokaOne
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.TextScaled = true

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.new(0, 0, 0)
    stroke.Parent = label

    label.Text = string.format("%s | %.0f/%.0f", Model.Name, humanoid.Health, humanoid.MaxHealth)

    local connections = {}

    table.insert(connections, humanoid.HealthChanged:Connect(function()
        if label and humanoid then
            label.Text = string.format("%s | %.0f/%.0f", Model.Name, humanoid.Health, humanoid.MaxHealth)
        end
    end))

    table.insert(connections, humanoid.Died:Connect(function()
        for _, c in pairs(connections) do if c and c.Connected then c:Disconnect() end end
        if espGui and espGui.Parent then espGui:Destroy() end
        NpcEspData[Model] = nil
    end))

    table.insert(connections, Model.AncestryChanged:Connect(function()
        if not Model:IsDescendantOf(enemiesFolder) then
            for _, c in pairs(connections) do if c and c.Connected then c:Disconnect() end end
            if espGui and espGui.Parent then espGui:Destroy() end
            NpcEspData[Model] = nil
        end
    end))

    NpcEspData[Model] = { gui = espGui, label = label, conns = connections }
end

enemiesFolder.ChildAdded:Connect(function(child)
    if not child then return end
    task.defer(function()
        local Humanoid = child:WaitForChild("Humanoid", 30)

        if settings.NPCEspActive and Humanoid ~= nil then
            createNpcEspForModel(child)
        end
    end)
end)

-- initially add existing enemies (only if setting on)
for _, Model in pairs(enemiesFolder:GetChildren()) do
    if Model:FindFirstChildOfClass("Humanoid") and settings.NPCEspActive then
        createNpcEspForModel(Model)
    end
end

local function clearNpcEsp()
    for Model, data in pairs(NpcEspData) do
        if data and data.conns then
            for _, c in pairs(data.conns) do if c and c.Connected then c:Disconnect() end end
        end
        if data.gui and data.gui.Parent then data.gui:Destroy() end
        NpcEspData[Model] = nil
    end
end

-- get player's boat (cached function)
local function getPlayerBoat()
    local Boat = BoatsFolder:FindFirstChild(LocalPlayer.Name.."Boat")
    local SkyShip = BoatsFolder:FindFirstChild(LocalPlayer.Name.."TempBoat")
    return Boat, SkyShip
end

-- clamp helper
local function clampSettings()
    settings.DamageMultiplier = math.clamp(tonumber(settings.DamageMultiplier) or 1, 1, 20)
    settings.BoatSpeedMultiplier = math.clamp(tonumber(settings.BoatSpeedMultiplier) or 1, 1, 50)
    settings.RepairMultiplier = math.clamp(tonumber(settings.RepairMultiplier) or 1, 1, 50)
    settings.WeaponDamageAmt = math.clamp(tonumber(settings.WeaponDamageAmt) or 0, 0, 9999)
end

-- Input handlers
uis.InputBegan:Connect(function(input, isChatBox)
    if isChatBox or not settings.SilentBottleDrinking or input.KeyCode ~= Enum.KeyCode.Period then return end
    Remotes.Misc.EmptyBottle:FireServer(true)
end)

-- Fishing listener optimized with safe Heartbeat handling
local function setupFishingListener()
    if childAddedConnection then childAddedConnection:Disconnect() end
    childAddedConnection = Character.ChildAdded:Connect(function(child)
        if not settings.AutoFish or child.Name ~= "FishBiteGoal" then return end
        if not FishingTool then return end

        if fishingType == "Silent" then
            local reelConn
            reelConn = runService.Heartbeat:Connect(function()
                if not child.Parent or child.Parent ~= Character then
                    if reelConn and reelConn.Connected then reelConn:Disconnect() end
                    return
                end
                -- throttle
                if not reelConn._last or tick() - reelConn._last > 0.12 then
                    reelConn._last = tick()
                    Remotes.Misc.FishState:FireServer("Reel")
                end
            end)
        else -- Legit
            task.spawn(function()
                while child.Parent == Character do
                    Remotes.Misc.ToolAction:FireServer(FishingTool)
                    task.wait(0.12)
                end
                -- re-equip flow preserved
                local hum = Character:FindFirstChildOfClass("Humanoid")
                if hum then
                    hum:UnequipTools()
                    task.wait(0.4)
                    hum:EquipTool(FishingTool)
                    task.delay(1, function() Remotes.Misc.ToolAction:FireServer(FishingTool) end)
                end
            end)
        end
    end)
end

setupFishingListener()

-- Fishing loop for legit type (single timer)
local fishingLoopTask = nil
local function startFishingLoop()
    if fishingLoopTask then fishingLoopTask._cancel = true end
    fishingLoopTask = { _cancel = false }
    task.spawn(function()
        while not fishingLoopTask._cancel do
            if FishingTool and fishingType == "Legit" and settings.AutoFish then
                if FishingTool.Parent == Character then
                    if not Character:FindFirstChild("FishClock") then
                        Remotes.Misc.ToolAction:FireServer(FishingTool)
                    end
                end
            end
            task.wait(4)
        end
    end)
end
startFishingLoop()

-- Teleport bind callback
TeleportBind.OnInvoke = function()
    if hecatePart ~= nil then
        local humanoidRoot = Character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot then
            humanoidRoot.CFrame = hecatePart.CFrame
        end
    end
end

-- Epicenter ESP management (throttled)
local hoverFrameConnection = nil
local function enableEpicenterESP(enabled)
    if not enabled then
        if espData.Gui then espData.Gui:Destroy() espData.Gui = nil espData.TrackingFrame = nil end
        if hoverFrameConnection and hoverFrameConnection.Connected then hoverFrameConnection:Disconnect() hoverFrameConnection = nil end
        return
    end

    if not espData.Gui then
        espData.Gui = Instance.new("ScreenGui")
        espData.Gui.Parent = coreGui
        espData.Gui.Name = "EpicenterESPGui"
        espData.Gui.ResetOnSpawn = false

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 50, 0, 50)
        frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        frame.BorderSizePixel = 2
        frame.Parent = espData.Gui
        frame.Visible = false
        frame.Name = "TrackingFrame"
        espData.TrackingFrame = frame
    end

    if hoverFrameConnection and hoverFrameConnection.Connected then hoverFrameConnection:Disconnect() hoverFrameConnection = nil end

    local lastUpdate = 0
    hoverFrameConnection = runService.Heartbeat:Connect(function(dt)
        if not settings.EpicenterESP or not espData.TrackingFrame or not espData.Gui then
            enableEpicenterESP(false)
            return
        end
        if tick() - lastUpdate < 0.05 then return end
        lastUpdate = tick()
        local centerPart = Map:FindFirstChild("The Epicenter") and Map:FindFirstChild("The Epicenter").Center
        if centerPart then
            local screenPos, onScreen = CurrentCamera:WorldToViewportPoint(centerPart.Position)
            if onScreen then
                espData.TrackingFrame.Position = UDim2.new(0, screenPos.X - (espData.TrackingFrame.AbsoluteSize.X / 2), 0, screenPos.Y - (espData.TrackingFrame.AbsoluteSize.Y / 2))
                espData.TrackingFrame.Visible = true
            else
                espData.TrackingFrame.Visible = false
            end
        else
            espData.TrackingFrame.Visible = false
        end
    end)
end

local function tweakShip(ship)
    if ship == nil then return end
    local center = ship:FindFirstChild("Center")
    if not center then return end
    local bodyVelocity = center:FindFirstChild("SailV")
    if bodyVelocity and bodyVelocity.Velocity.Magnitude > 5 then
        local speedVal = (ship.Speed and ship.Speed.Value or 0) * 0.5
        bodyVelocity.Velocity = bodyVelocity.Velocity.Unit * (speedVal) * settings.BoatSpeedMultiplier
    end
end

-- RunService.PreSimulation boat speed handler (kept, cheap checks)
runService.PreSimulation:Connect(function()
    if not settings.BoostBoatSpeed then return end
    if settings.BoatSpeedMultiplier <= 1 then return end

    local Boat,SkyShip = getPlayerBoat()

    tweakShip(Boat)
    tweakShip(SkyShip)

    if Character and Character:FindFirstChild("Humanoid") and Character.Humanoid.SeatPart ~= nil then
        local Seat = Character.Humanoid.SeatPart
        local OtherShip = Seat.Parent
        if OtherShip and OtherShip ~= Boat and OtherShip ~= SkyShip then
            local bodyVelocity = OtherShip.Center and OtherShip.Center:FindFirstChild("SailV")
            if bodyVelocity and bodyVelocity.Velocity.Magnitude > 5 then
                local speedVal = (OtherShip.Speed and OtherShip.Speed.Value or 0) * 0.5
                bodyVelocity.Velocity = bodyVelocity.Velocity.Unit * (speedVal) * settings.BoatSpeedMultiplier
            end
        end
    end
end)

local masterHook
masterHook = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    local remoteName = tostring(self.Name)

    if not checkcaller() then
        -- Reduce stamina
        if remoteName == "StaminaCost" and method == "FireServer" and settings.ReduceStamina then
            if args[1] then args[1] = 0 end
            return masterHook(self, unpack(args))
        end

        -- God Mode Hook (early outs preserved)
        if method == "FireServer" and settings.GodMode then
            if remoteName == "DealAttackDamage" or remoteName == "DealBossDamage" then
                if args[2] == Character then return end
            elseif remoteName == "DealMagicDamage" then
                if args[2] == Character then return end
            elseif remoteName == "DealWeaponDamage" or remoteName == "DealStrengthDamage" or remoteName == "DealSWDamage" then
                if args[3] == Character then return end
            elseif remoteName == "TouchDamage" or remoteName == "MiscDamage" or remoteName == "TakeSideDamage" or remoteName == "FallDamage" then
                return
            end
        end

        -- One-tap structures: original fired many times in a loop. Do a smaller clamp to avoid spam
        if remoteName == "DamageStructure" and method == "InvokeServer" and settings.OneTapStructures then
            for i = 1, settings.DamageMultiplier do
                masterHook(self, unpack(args))
            end
        end

        -- NPC Aggro block
        if (remoteName == "TargetBehavior" or remoteName == "ChangeStatus") and settings.BlockNPCAggro then
            return
        end

        -- Damage multiplier hook: clamp multiplier to reasonable max to avoid huge spam
        if DAMAGE_REMOTES_SET[remoteName] and method == "FireServer" and settings.EnableDamageMultiplier then
            local mult = tonumber(settings.DamageMultiplier)
            for i = 1, mult do
                masterHook(self, unpack(args))
            end
        end

        -- Weapon dmg mult (single modification)
        if remoteName == "DealWeaponDamage" and method == "FireServer" and settings.WeaponDamageMultiplier then
            if args[3] == Character then return end
            if args[1] then args[1] = settings.WeaponDamageAmt end
        end

        -- Fast boat repair (clamped)
        if remoteName == "RepairHammer" and method == "InvokeServer" and settings.FastBoatRepair then
            for i = 1, settings.RepairMultiplier do
                masterHook(self, unpack(args))
            end
        end
    end

    return masterHook(self, unpack(args))
end))

-- UI components (callbacks updated)
GodmodeSection:AddToggle({ Name = "Godmode", Default = false, Callback = function(value) settings.GodMode = value end })

WeaponEXPSection:AddToggle({ Name = "Weapon DMG Multiplier", Default = false, Callback = function(value) settings.WeaponDamageMultiplier = value end })

WeaponEXPSection:AddSlider({
    Name = "Mulitplier",
    Default = 1, Min = 1, Max = 999, Round = 0,
    Callback = function(value)
        if tonumber(value) then settings.WeaponDamageAmt = tonumber(value) end
    end
})

GodmodeSection:AddButton({
    Name = "NaN godmode.",
    Risky = true,
    Callback = function()
        if not hookfunction then Notifier.new({Title = "Error!", Content = "Your executor does not have hookfunction()"}); return end
        if not debug.getinfo then Notifier.new({Title = "Error!", Content = "Your executor does not have debug.getinfo()"}); return end
        if not getfenv then Notifier.new({Title = "Error!", Content = "Your executor does not have getfenv()"}); return end
        if not getgc then Notifier.new({Title = "Error!", Content = "Your executor does not have getgc()"}); return end

        for i, v in next, getgc() do
            if type(v) == "function" and tostring(getfenv(v).script) == "QuestsHandler" then
                if debug.getinfo(v).name == "EnemySideQuestCheck" then
                    hookfunction(v, function() return end)
                end
            end
        end

        for i, v in next, ReplicatedStorage.RS.Story.Enemies:GetChildren() do
            if v:FindFirstChild("AppearAt") and not enemiesFolder:FindFirstChild(v.Name) then
                v.AppearAt.Value = 0
                v.Parent = enemiesFolder
            end
        end

        for i, v in next, ReplicatedStorage.RS.Quest.Enemies:GetChildren() do
            if v:FindFirstChild("AppearAtQuest") and not enemiesFolder:FindFirstChild("Cernyx") then
                v.AppearAtQuest.Value = 0
                v.Parent = enemiesFolder
            end
        end

        task.wait(2)
        if game.PlaceId == 15449776494 or game.PlaceId == 18122795128 then
            local OldPos = Character:FindFirstChild("HumanoidRootPart").CFrame
            local Maria = enemiesFolder:FindFirstChild("Captain Maria2")
            if not Maria then return end

            Character:FindFirstChild("HumanoidRootPart").CFrame = Maria.HumanoidRootPart.CFrame
            RS.Remotes.NPC.TargetBehavior:InvokeServer(Maria)

            task.wait(0.5)

            local args = { Maria, Character, "Maria Slashes", 0/0 }
            RS.Remotes.Combat.DealBossDamage:FireServer(unpack(args))

            Character.HumanoidRootPart.CFrame = OldPos
        elseif game.PlaceId == 12604352060 or game.PlaceId == 18122780138 then
            local OldPos = Character:FindFirstChild("HumanoidRootPart").CFrame
            local Calvus = enemiesFolder:FindFirstChild("King Calvus")
            if not Calvus then return end

            Character:FindFirstChild("HumanoidRootPart").CFrame = Calvus.HumanoidRootPart.CFrame
            RS.Remotes.NPC.TargetBehavior:InvokeServer(Calvus)

            task.wait(0.5)

            local args = { Calvus, Character, "Calvus Blast Fire", 0/0 }
            RS.Remotes.Combat.DealBossDamage:FireServer(unpack(args))

            Character.HumanoidRootPart.CFrame = OldPos
        end
    end
})

NPCSection:AddToggle({
    Name = "No NPC Aggro",
    Default = false,
    Callback = function(value) settings.BlockNPCAggro = value end
})

NPCSection:AddToggle({
    Name = "NPC Esp",
    Default = false,
    Callback = function(value)
        settings.NPCEspActive = value
        if value then
            for _, model in pairs(enemiesFolder:GetChildren()) do
                if model:FindFirstChildOfClass("Humanoid") then createNpcEspForModel(model) end
            end
        else
            clearNpcEsp()
        end
    end
})

PlayerSection:AddSlider({
    Name = "FOV (Field Of View)",
    Default = CurrentCamera.FieldOfView, Min = 70, Max = 120, Round = 0,
    Callback = function(value) if tonumber(value) then CurrentCamera.FieldOfView = value end end
})

PlayerSection:AddToggle({ Name = "Reduced stamina consumption", Default = false, Callback = function(value) settings.ReduceStamina = value end })

PlayerSection:AddToggle({
    Name = "Drink Bottles Silently",
    Default = false,
    Callback = function(value) settings.SilentBottleDrinking = value Notifier.new({Title = "Keybind!", Content = "The default keybind is '.'"}); end
})

PlayerSection:AddToggle({ Name = "One tap buildings/structures", Default = false, Callback = function(value) settings.OneTapStructures = value end })

PlayerSection:AddToggle({
    Name = "Infinite camera zoom",
    Default = false,
    Callback = function(value)
        if value then
            infiniteZoomConnection = LocalPlayer:GetPropertyChangedSignal("CameraMaxZoomDistance"):Connect(function() LocalPlayer.CameraMaxZoomDistance = math.huge end)
            LocalPlayer.CameraMaxZoomDistance = math.huge
        elseif infiniteZoomConnection then
            infiniteZoomConnection:Disconnect()
            LocalPlayer.CameraMaxZoomDistance = oldZoomDistance
            infiniteZoomConnection = nil
        end
    end
})

PlayerSection:AddToggle({
    Name = "No fog",
    Default = false,
    Callback = function(value)
        if value then
            OldAtmosphere = lighting:FindFirstChildOfClass("Atmosphere")
            if OldAtmosphere then OldAtmosphere.Parent = replicated end
            local NewAtmosphere = Instance.new("Atmosphere")
            NewAtmosphere.Parent = lighting
            NewAtmosphere.Density = 0
        else
            local atm = lighting:FindFirstChildOfClass("Atmosphere")
            if atm then atm:Destroy() end
            if OldAtmosphere then OldAtmosphere.Parent = lighting end
        end
    end
})

PlayerSection:AddToggle({ Name = "No blur", Default = false, Callback = function(value) local b = lighting:FindFirstChildOfClass("BlurEffect") if b then b.Enabled = not value end end })
PlayerSection:AddToggle({ Name = "No depth of field", Default = false, Callback = function(value) local d = lighting:FindFirstChildOfClass("DepthOfFieldEffect") if d then d.Enabled = not value end end })
PlayerSection:AddToggle({ Name = "No sun rays", Default = false, Callback = function(value) local s = lighting:FindFirstChildOfClass("SunRaysEffect") if s then s.Enabled = not value end end })
PlayerSection:AddToggle({ Name = "No color correction", Default = false, Callback = function(value) local c = lighting:FindFirstChildOfClass("ColorCorrectionEffect") if c then c.Enabled = not value end end })
PlayerSection:AddToggle({ Name = "No bloom", Default = false, Callback = function(value) local b = lighting:FindFirstChildOfClass("BloomEffect") if b then b.Enabled = not value end end })

PlayerSection:AddToggle({
    Name = "Full bright",
    Default = false,
    Callback = function(value)
        lighting.Brightness = value and 1 or 0
        lighting.ClockTime = value and 12 or OldTimeModule()
        lighting.FogEnd = value and 100000 or 500
        lighting.GlobalShadows = not value
        lighting.Ambient = value and Color3.fromRGB(255,255,255) or Color3.fromRGB(0,0,0)
    end
})

PlayerSection:AddButton({
    Name = "Stamina boost",
    Risky = true,
    Callback = function()
        if StaminaBoostDebounce == true then return end
        StaminaBoostDebounce = true
        Remotes.Combat.StaminaCost:FireServer(-2, "Dodge")
        task.delay(5, function() StaminaBoostDebounce = false end)
    end
})

PlayerSection:AddButton({
    Name = "Discover all islands",
    Callback = function()
        for _, island in pairs(Map:GetChildren()) do
            if island:FindFirstChild("Center") then
                Remotes.Misc.UpdateLastSeen:FireServer(island.Name, "")
                task.wait(0.05)
            end
        end
    end
})

DamageSection:AddToggle({ Name = "Enable damage multiplier", Default = false, Callback = function(value) settings.EnableDamageMultiplier = value clampSettings() end })
DamageSection:AddSlider({
    Name = "Damage Multiplier",
    Default = 1, Min = 1, Max = 500, Round = 0,
    Callback = function(value) if tonumber(value) then settings.DamageMultiplier = tonumber(value) clampSettings() end end
})

BoatSection:AddToggle({ Name = "Fast boat repair", Default = false, Callback = function(value) settings.FastBoatRepair = value end })
BoatSection:AddSlider({ Name = "Repair Multiplier", Default = 1, Min = 1, Max = 50, Round = 0, Callback = function(value) if tonumber(value) then settings.RepairMultiplier = tonumber(value) end end })
BoatSection:AddToggle({ Name = "Boost boat speed", Default = false, Callback = function(value) settings.BoostBoatSpeed = value end })
BoatSection:AddSlider({ Name = "Boat speed multiplier", Default = 1, Min = 1, Max = 50, Round = 0, Callback = function(value) if tonumber(value) then settings.BoatSpeedMultiplier = tonumber(value) end end })

BoatSection:AddButton({ Name = "Teleport to boat.", Callback = function()
    local boat = getPlayerBoat()
    if not boat then return end
    local humanoid = Character:FindFirstChild("Humanoid")
    if humanoid then
        local SteerSeat = boat:WaitForChild("SteerSeat")

        if SteerSeat == nil then return end

        SteerSeat:Sit(humanoid)
    end
end })

EatSection:AddToggle({ Name = "Toggle auto eat", Default = false, Callback = function(value) settings.AutoEat = value end })
EatSection:AddDropdown({ Name = "Food Item", Values = {"Banana", "Red apple", "Green apple"}, Callback = function(value) modifiedStats.FoodItem = value end })

ItemsSection:AddButton({ Name = "Item ESP", Callback = function() scanIslandItems(Map, Character, registerItemESP) end })
ItemsSection:AddButton({ Name = "Clear Item ESP", Callback = function()
    for part, record in pairs(espData.RegisteredMap) do
        if record.gui and record.gui.Parent then record.gui:Destroy() end
        if record.conns then
            for _, c in pairs(record.conns) do if c and c.Connected then c:Disconnect() end end
        end
    end
    espData.RegisteredMap = {}
end })

ItemsSection:AddButton({ Name = "Quick fill bottles.", Callback = function()
    if fillDebounce then return end
    fillDebounce = true
    local humanoid = Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:UnequipTools()
        for _ = 1, 100 do Remotes.Misc.EmptyBottle:FireServer() end
        task.delay(1, function() fillDebounce = false end)
    else
        fillDebounce = false
    end
end })

ItemsSection:AddSlider({
    Name = "Item ESP Range",
    Default = 1000, 
    Min = 1000, 
    Max = 10000, 
    Round = 0,
    Callback = function(value)
        settings.ItemEspRadius = tonumber(value)
    end
})

ChestExploitsSection:AddToggle({ Name = "Chest Aura", Default = false, Callback = function(value) settings.ChestAura = value end })
ChestExploitsSection:AddSlider({ Name = "Chest Radius", Default = 25, Min = 1, Max = 50, Round = 0, Callback = function(value) if tonumber(value) then settings.ChestRadius = tonumber(value) end end })
ChestExploitsSection:AddButton({
    Name = "Legendary Chest grabber. (laggy)",
    Callback = function()
        if LChestDebounce == true then return end
        LChestDebounce = true
       GrabLegendaryChests()
    end
})

-- chest aura (lower frequency, uses cached list)
scheduler:add("chest_aura", 1.2, function()
    if not settings.ChestAura then return end
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return end
    local rootPos = Character.HumanoidRootPart.Position
    for _, chest in pairs(cachedChestParts) do
        if chest and chest.Parent and chest:FindFirstChild("Base") then
            local base = chest:FindFirstChild("Base")
            if base and (rootPos - base.Position).Magnitude <= (settings.ChestRadius + 10) then
                OpenChest(chest)
            end
        end
    end
end)

-- auto eat
scheduler:add("auto_eat", 10, function()
    if not settings.AutoEat then return end
    if not modifiedStats.FoodItem then return end
    local Tool = LocalPlayer.Backpack:FindFirstChild(modifiedStats.FoodItem)
    if Tool then Remotes.Misc.ToolAction:FireServer(Tool) end
end)

-- auto wash
scheduler:add("auto_wash", 5, function()
    if settings.AutoWash then Remotes.Boats.Wash:FireServer() end
end)

-- hecate notifier
scheduler:add("hecate_notifier", 5, function()
    if not settings.HecateNotifier or not DarkSeaFolder then return end
    for _, child in pairs(DarkSeaFolder:GetChildren()) do
        if child.Name == "Island" and child:FindFirstChild("HecateEssence") then
            starterGui:SetCore("SendNotification", {
                Title = "Hecate found!",
                Text = "Click the button below to teleport.",
                Duration = 5,
                Button1 = "Teleport",
                Callback = TeleportBind
            })
            hecatePart = child:FindFirstChild("HecateEssence")
            break
        end
    end
end)

-- unload players to NPCs (throttled)
scheduler:add("unload_players", 5, function()
    for _, player in pairs(ReplicatedStorage.RS.UnloadPlayers:GetChildren()) do
        player.Parent = NPCs
    end
end)

-- rebuild chest cache on demand (rare)
scheduler:add("rebuild_chest_cache", 15, function() buildChestCache() end)

-- clamp settings periodically
scheduler:add("clamp_settings", 2, function() clampSettings() end)

-- run scheduler per-bucket tickers
-- bucket tick map
local bucketTick = {
    [0.1] = 0.1,
    [0.5] = 0.1, -- check every 0.1 but only run tasks when nextRun due
    [1]   = 0.2,
    [5]   = 0.5,
    [15]  = 1,
}

for bucketInterval, _ in pairs(scheduler.buckets) do
    task.spawn(function()
        while true do
            local now = tick()
            local bucket = scheduler.buckets[bucketInterval]
            for name, t in pairs(bucket) do
                if t and t.nextRun <= now then
                    task.spawn(t.fn)
                    t.nextRun = now + t.interval
                end
            end
            task.wait(bucketTick[bucketInterval] or 0.2)
        end
    end)
end

-- keep fishing listener updated on character change
LocalPlayer.CharacterAdded:Connect(function(Char)
    Character = Char
    setupFishingListener()
    startFishingLoop()
    if fishingToolName then
        FishingTool = LocalPlayer.Backpack:FindFirstChild(fishingToolName) or Character:FindFirstChild(fishingToolName)
        if not FishingTool then Notifier.new({Title = "Warning!", Content = "Fishing tool not found in backpack. Please reselect the fishing tool."}) end
    end
end)

-- UI bits left intact (Magic/Melee/Weapon/Armor UI)
MagicSection:AddDropdown({ Name = "[Magic]", Values = magicTypes, Callback = function(value) if MagicModule.Types[value] then modifiedStats.Magic = value end end })
MagicSection:AddDropdown({ Name = "[Magic 2]", Values = magicTypes, Callback = function(value) if MagicModule.Types[value] then modifiedStats.Magic2 = value end end })
MagicSection:AddTextBox({ Name = "Size", Default = "1", Callback = function(value)
    if not modifiedStats.Magic or modifiedStats.Magic == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MagicModule.Types[modifiedStats.Magic].Size = num
    if modifiedStats.Magic2 and modifiedStats.Magic2 ~= "None" then MagicModule.Types[modifiedStats.Magic2].Size = num end
    if num > 75 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: 75"}); end
end })
MagicSection:AddTextBox({ Name = "Speed", Default = "1", Callback = function(value)
    if not modifiedStats.Magic or modifiedStats.Magic == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MagicModule.Types[modifiedStats.Magic].Speed = num
    if modifiedStats.Magic2 and modifiedStats.Magic2 ~= "None" then MagicModule.Types[modifiedStats.Magic2].Speed = num end
    if num > 3 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: <3"}); end
end })
MagicSection:AddTextBox({ Name = "Imbue Speed", Default = "1", Callback = function(value)
    if not modifiedStats.Magic or modifiedStats.Magic == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MagicModule.Types[modifiedStats.Magic].ImbueSpeed = num
    if modifiedStats.Magic2 and modifiedStats.Magic2 ~= "None" then MagicModule.Types[modifiedStats.Magic2].ImbueSpeed = num end
    if num > 3 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: <3"}); end
end })

MeleeSection:AddDropdown({ Name = "[Fighting Style]", Values = meleeTypes, Callback = function(value) if MeleeModule.Types[value] then modifiedStats.Melee = value end end })
MeleeSection:AddDropdown({ Name = "[Fighting Style 2]", Values = meleeTypes, Callback = function(value) if MeleeModule.Types[value] then modifiedStats.Melee2 = value end end })
MeleeSection:AddTextBox({ Name = "Size", Default = "1", Callback = function(value)
    if not modifiedStats.Melee or modifiedStats.Melee == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MeleeModule.Types[modifiedStats.Melee].Size = num
    if modifiedStats.Melee2 and modifiedStats.Melee2 ~= "None" then MeleeModule.Types[modifiedStats.Melee2].Size = num end
    if num > 5 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: < 5"}); end
end })
MeleeSection:AddTextBox({ Name = "Speed", Default = "1", Callback = function(value)
    if not modifiedStats.Melee or modifiedStats.Melee == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MeleeModule.Types[modifiedStats.Melee].Speed = num
    if modifiedStats.Melee2 and modifiedStats.Melee2 ~= "None" then MeleeModule.Types[modifiedStats.Melee2].Speed = num end
    if num > 3 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: < 3"}); end
end })
MeleeSection:AddTextBox({ Name = "Imbue Speed", Default = "1", Callback = function(value)
    if not modifiedStats.Melee or modifiedStats.Melee == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    MeleeModule.Types[modifiedStats.Melee].ImbueSpeed = num
    if modifiedStats.Melee2 and modifiedStats.Melee2 ~= "None" then MeleeModule.Types[modifiedStats.Melee2].ImbueSpeed = num end
    if num > 3 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: < 3"}); end
end })

WeaponsSection:AddDropdown({ Name = "[Weapon]", Values = weaponTypes, Callback = function(value) if InventoryModule.Items[value] then modifiedStats.Weapon = value end end })
WeaponsSection:AddDropdown({ Name = "[Weapon 2]", Values = weaponTypes, Callback = function(value) if InventoryModule.Items[value] then modifiedStats.Weapon2 = value end end })
WeaponsSection:AddDropdown({ Name = "[Weapon 3]", Values = weaponTypes, Callback = function(value) if InventoryModule.Items[value] then modifiedStats.Weapon3 = value end end })

WeaponsSection:AddTextBox({ Name = "Size", Default = "1", Callback = function(value)
    if not modifiedStats.Weapon or modifiedStats.Weapon == "None" or not tonumber(value) then return end
    local num = tonumber(value)
    InventoryModule.Items[modifiedStats.Weapon].Specs["Attack Size"].Value = num
    if modifiedStats.Weapon2 and modifiedStats.Weapon2 ~= "None" then InventoryModule.Items[modifiedStats.Weapon2].Specs["Attack Size"].Value = num end
    if modifiedStats.Weapon3 and modifiedStats.Weapon3 ~= "None" then InventoryModule.Items[modifiedStats.Weapon3].Specs["Attack Size"].Value = num end
    if num > 75 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: < 75"}); end
end })
WeaponsSection:AddTextBox({ Name = "Speed", Default = "1", Callback = function(value)
    if not modifiedStats.Weapon or not tonumber(value) then return end
    local num = tonumber(value)
    InventoryModule.Items[modifiedStats.Weapon].Specs["Attack Speed"].Value = num
    if modifiedStats.Weapon2 and modifiedStats.Weapon2 ~= "None" then InventoryModule.Items[modifiedStats.Weapon2].Specs["Attack Speed"].Value = num end
    if modifiedStats.Weapon3 and modifiedStats.Weapon3 ~= "None" then InventoryModule.Items[modifiedStats.Weapon3].Specs["Attack Speed"].Value = num end
    if num > 3 then Notifier.new({Title = "Warning!", Content = "This could break your game if you set it too high. \n Suggested value: < 3"}); end
end })

ArmorSection:AddDropdown({ Name = "Armor", Values = itemTypes, Callback = function(value) if InventoryModule.Items[value] then modifiedStats.Armor = value end end })
ArmorSection:AddTextBox({ Name = "Attack Size", Default = "1", Callback = function(value) if not modifiedStats.Armor or not tonumber(value) then return end InventoryModule.Items[modifiedStats.Armor].Stats.AttackSize = tonumber(value) end })
ArmorSection:AddTextBox({ Name = "Attack Speed", Default = "1", Callback = function(value) if not modifiedStats.Armor or not tonumber(value) then return end InventoryModule.Items[modifiedStats.Armor].Stats.AttackSpeed = tonumber(value) end })
ArmorSection:AddTextBox({ Name = "Agility", Default = "1", Callback = function(value) if not modifiedStats.Armor or not tonumber(value) then return end InventoryModule.Items[modifiedStats.Armor].Stats.Agility = tonumber(value) end })
ArmorSection:AddTextBox({ Name = "Warding", Default = "1", Callback = function(value) if not modifiedStats.Armor or not tonumber(value) then return end InventoryModule.Items[modifiedStats.Armor].Stats.Warding = tonumber(value) end })

UISection:AddKeybind({ Name = "Toggle UI", Default = Enum.KeyCode.Equals, Callback = function() Window:toggle() end })

-- Misc / DarkSea / Fishing UI (kept)
FishingSection:AddTextBox({ Name = "Fishing Tool", Default = "None", Callback = function(value)
    if not value then return end
    fishingToolName = value
    FishingTool = LocalPlayer.Backpack:FindFirstChild(value) or Character:FindFirstChild(value)
    if FishingTool ~= nil then Notifier.new({Title = "Alert!", Content = "Fishing tool found."}) end
end })

FishingSection:AddToggle({ Name = "Toggle auto fish", Default = false, Callback = function(value)
    if not FishingTool then Notifier.new({Title = "Warning!", Content = "Select a fishing tool first."}); settings.AutoFish = false; return end
    settings.AutoFish = value
    if value then
        if fishingType == "Silent" then
            local CharPos = Character.HumanoidRootPart.Position
            local args = {[1] = FishingTool, [3] = vector.create(CharPos.X, 398.7853088378906, CharPos.Z)}
            Remotes.Misc.FishClock:FireServer(unpack(args))
        else
            Character:FindFirstChildOfClass("Humanoid"):UnequipTools()
            task.wait(0.2)
            Character:FindFirstChildOfClass("Humanoid"):EquipTool(FishingTool)
            task.wait(0.2)
            Remotes.Misc.ToolAction:FireServer(Character:FindFirstChildOfClass("Tool"))
        end
    end
end })

FishingSection:AddDropdown({ Name = "Fishing Type", Values = {"Legit"}, Callback = function(value) fishingType = value end })

PlayerSection:AddToggle({ Name = "Toggle insanity", Default = true, Callback = function(value)
    local temp = LocalPlayer.PlayerGui:FindFirstChild("Temp")
    if temp then
        local insanityScript = temp:FindFirstChild("Insanity")
        if insanityScript then insanityScript.Disabled = not value end
    end
end })

DarkSeaSection:AddButton({ Name = "Disable fog circle", Callback = function()
    local tempGui = LocalPlayer.PlayerGui:FindFirstChild("Temp")
    local darkSeaGui = tempGui and tempGui:FindFirstChild("DarkSea")
    if darkSeaGui then
        local sky1 = darkSeaGui:FindFirstChild("DarkSky1")
        local sky2 = darkSeaGui:FindFirstChild("DarkSky2")
        if sky1 and sky1:FindFirstChildOfClass("SpecialMesh") then sky1:FindFirstChildOfClass("SpecialMesh"):Destroy() end
        if sky2 and sky2:FindFirstChildOfClass("SpecialMesh") then sky2:FindFirstChildOfClass("SpecialMesh"):Destroy() end
    end
    local camSky1 = CurrentCamera:FindFirstChild("DarkSky1")
    local camSky2 = CurrentCamera:FindFirstChild("DarkSky2")
    if camSky1 and camSky1:FindFirstChildOfClass("SpecialMesh") then camSky1:FindFirstChildOfClass("SpecialMesh"):Destroy() end
    if camSky2 and camSky2:FindFirstChildOfClass("SpecialMesh") then camSky2:FindFirstChildOfClass("SpecialMesh"):Destroy() end
end })

DarkSeaSection:AddButton({ Name = "Disable dark sea rain", Callback = function()
    local overheadFX = workspace.Camera:FindFirstChild("OverheadFX")
    if overheadFX then
        if overheadFX:FindFirstChild("DSRain") then overheadFX.DSRain.Lifetime = NumberRange.new(0,0) end
        if overheadFX:FindFirstChild("DSRain2") then overheadFX.DSRain2.Lifetime = NumberRange.new(0,0) end
    end
end })

DarkSeaSection:AddToggle({ Name = "Toggle auto wash bin", Default = false, Callback = function(value) settings.AutoWash = value end })
DarkSeaSection:AddToggle({ Name = "Hecate essence notifier", Default = false, Callback = function(value) settings.HecateNotifier = value end })

DarkSeaSection:AddToggle({
    Name = "Epicenter ESP",
    Default = false,
    Callback = function(value)
        settings.EpicenterESP = value
        enableEpicenterESP(value)
    end
})

MiscSection:AddButton({ Name = "Quick clear notoriety", Callback = function() Remotes.UI.ClearBounty:InvokeServer("ClearNotoriety") end })
MiscSection:AddDropdown({ Name = "Animation Packs", Values = {"Coward", "Boss", "Cute", "Lazy", "Fighter","Assassin", "Sorcerer"}, Callback = function(value) BasicModule.GetAnimationPack = function() return value end Notifier.new({Title = "Warning!", Content = "This won't apply until you reset."}); end })

TeleportSection:AddDropdown({
    Name = "Teleports",
    Values = teleportLocations,
    Callback = function(value)
        if teleportDebounce then return end
        teleportDebounce = true
        local island = Map:FindFirstChild(value)
        if not island then teleportDebounce = false return end
        local center = island:FindFirstChild("Center")
        if not center then teleportDebounce = false return end

        if value == "Harvest Island" then
            local oldPos = center.Position
            center.Position = Vector3.new(7236, 598, 343)
            task.delay(1, function() center.Position = oldPos end)
        end

        local landingPos = value == "Mount Othrys" and CFrame.new(0, -25000, 0) or CFrame.new(0, 1000, 0)
        local humanoidRoot = Character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot then
            humanoidRoot.CFrame = center.CFrame * landingPos
            humanoidRoot.Anchored = true
            task.delay(15, function() if humanoidRoot then humanoidRoot.Anchored = false end teleportDebounce = false end)
        else
            teleportDebounce = false
        end
    end
})

-- Final theme UI
local SettingTab = Window:DrawTab({ Icon = "settings-3", Name = "Settings", Type = "Single", EnableScrolling = true });
local ThemeTab = Window:DrawTab({ Icon = "paintbrush", Name = "Themes", Type = "Single" });

local Settings = SettingTab:DrawSection({ Name = "UI Settings", });
Settings:AddToggle({ Name = "Alway Show Frame", Default = false, Callback = function(v) Window.AlwayShowTab = v end })

ThemeTab:DrawSection({ Name = "UI Themes" }):AddDropdown({
    Name = "Select Theme", Default = "Purple Rose", Values = { "Default", "Purple Rose", },
    Callback = function(v) Compkiller:SetTheme(v) end,
})
Compkiller:SetTheme("Purple Rose")
